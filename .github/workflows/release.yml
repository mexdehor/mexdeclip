name: Release

on:
  push:
    branches:
      - main
      - master

permissions:
  contents: write

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.check-release.outputs.version }}
      released: ${{ steps.check-release.outputs.released }}
      tag: ${{ steps.check-release.outputs.tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: npm install

      - name: Get tags before semantic-release
        id: tags-before
        run: |
          git fetch --tags || true
          TAGS_BEFORE=$(git tag --list | sort -V | tail -1 || echo "")
          echo "tags_before=$TAGS_BEFORE" >> $GITHUB_OUTPUT

      - name: Run semantic-release
        id: semantic
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          npx semantic-release || true

      - name: Check if release was created
        id: check-release
        run: |
          git fetch --tags || true
          TAGS_AFTER=$(git tag --list | sort -V | tail -1 || echo "")
          TAGS_BEFORE="${{ steps.tags-before.outputs.tags_before }}"

          # Check if a new tag was created
          if [ -n "$TAGS_AFTER" ] && [ "$TAGS_AFTER" != "$TAGS_BEFORE" ]; then
            VERSION=${TAGS_AFTER#v}
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "released=true" >> $GITHUB_OUTPUT
            echo "tag=$TAGS_AFTER" >> $GITHUB_OUTPUT
          else
            echo "released=false" >> $GITHUB_OUTPUT
            echo "version=" >> $GITHUB_OUTPUT
            echo "tag=" >> $GITHUB_OUTPUT
          fi

      - name: Output release status
        run: |
          echo "Release created: ${{ steps.check-release.outputs.released }}"
          echo "Version: ${{ steps.check-release.outputs.version }}"
          echo "Tag: ${{ steps.check-release.outputs.tag }}"

  build-linux:
    name: Build Linux
    needs: create-release
    if: needs.create-release.outputs.released == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.create-release.outputs.tag }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            xdg-utils

      - name: Install dependencies
        run: npm install

      - name: Update version in config files
        run: |
          VERSION="${{ needs.create-release.outputs.version }}"
          echo "Updating version to $VERSION"

          # Update Cargo.toml
          sed -i "s/^version = \".*\"/version = \"$VERSION\"/" src-tauri/Cargo.toml

          # Update tauri.conf.json
          sed -i "s/\"version\": \".*\"/\"version\": \"$VERSION\"/" src-tauri/tauri.conf.json

          # Verify updates
          echo "Cargo.toml version:"
          grep "^version" src-tauri/Cargo.toml
          echo "tauri.conf.json version:"
          grep "version" src-tauri/tauri.conf.json

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          projectPath: .
          tagName: ${{ needs.create-release.outputs.tag }}
          releaseName: "${{ needs.create-release.outputs.tag }}"
          releaseBody: "See the assets to download and install this version."
          releaseDraft: false
          prerelease: false
          args: "--bundles appimage deb"

  build-macos:
    name: Build macOS
    needs: create-release
    if: needs.create-release.outputs.released == 'true'
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.create-release.outputs.tag }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: npm install

      - name: Update version in config files
        run: |
          VERSION="${{ needs.create-release.outputs.version }}"
          echo "Updating version to $VERSION"

          # Update Cargo.toml (macOS sed syntax)
          sed -i '' "s/^version = \".*\"/version = \"$VERSION\"/" src-tauri/Cargo.toml

          # Update tauri.conf.json (macOS sed syntax)
          sed -i '' "s/\"version\": \".*\"/\"version\": \"$VERSION\"/" src-tauri/tauri.conf.json

          # Verify updates
          echo "Cargo.toml version:"
          grep "^version" src-tauri/Cargo.toml
          echo "tauri.conf.json version:"
          grep "version" src-tauri/tauri.conf.json

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          projectPath: .
          tagName: ${{ needs.create-release.outputs.tag }}
          releaseName: "${{ needs.create-release.outputs.tag }}"
          releaseBody: "See the assets to download and install this version."
          releaseDraft: false
          prerelease: false
          args: "--bundles dmg"
